# ===================================================================================
# GOVCONNECT SERVICES - DOCKER COMPOSE
# ===================================================================================
# 
# USAGE:
#   Local dev:   docker compose up -d --build
#   Production:  IMAGE_DASHBOARD=ghcr.io/... IMAGE_CHANNEL=ghcr.io/... docker compose up -d --pull always
#
# ===================================================================================

services:
  # ===================================================================================
  # Service 1: Channel Service (WhatsApp Channel)
  # ===================================================================================
  channel-service:
    image: ${IMAGE_CHANNEL:-govconnect-channel-service:local}
    build:
      context: ./govconnect-channel-service
      dockerfile: Dockerfile
    container_name: govconnect-channel-service
    ports:
      - "127.0.0.1:3001:3001"
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL_CHANNEL}
    volumes:
      - channel-uploads:/app/uploads
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - govconnect-network
      - infra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===================================================================================
  # Service 2: AI Orchestrator (with Vector Database)
  # ===================================================================================
  ai-service:
    image: ${IMAGE_AI:-govconnect-ai-service:local}
    build:
      context: ./govconnect-ai-service
      dockerfile: Dockerfile
    container_name: govconnect-ai-service
    ports:
      - "127.0.0.1:3002:3002"
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL_AI}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - govconnect-network
      - infra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===================================================================================
  # Service 3: Case Service (Laporan & Tiket)
  # ===================================================================================
  case-service:
    image: ${IMAGE_CASE:-govconnect-case-service:local}
    build:
      context: ./govconnect-case-service
      dockerfile: Dockerfile
    container_name: govconnect-case-service
    ports:
      - "127.0.0.1:3003:3003"
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL_CASE}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - govconnect-network
      - infra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===================================================================================
  # Service 4: Notification Service
  # ===================================================================================
  notification-service:
    image: ${IMAGE_NOTIFICATION:-govconnect-notification-service:local}
    build:
      context: ./govconnect-notification-service
      dockerfile: Dockerfile
    container_name: govconnect-notification-service
    ports:
      - "127.0.0.1:3004:3004"
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL_NOTIFICATION}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - govconnect-network
      - infra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===================================================================================
  # Service 5: Dashboard (Next.js)
  # ===================================================================================
  dashboard:
    image: ${IMAGE_DASHBOARD:-govconnect-dashboard:local}
    build:
      context: ./govconnect-dashboard
      dockerfile: Dockerfile
    container_name: govconnect-dashboard
    ports:
      - "127.0.0.1:${DASHBOARD_PORT:-3000}:3000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=${DATABASE_URL_DASHBOARD}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - govconnect-network
      - infra-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:3000/"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s

# ===================================================================================
# NETWORKS
# ===================================================================================
networks:
  govconnect-network:
    external: true
    name: govconnect-network
  infra-network:
    external: true
    name: infra-network

# ===================================================================================
# VOLUMES
# ===================================================================================
volumes:
  channel-uploads:
    name: gc-channel-uploads
