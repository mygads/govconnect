# ===================================================================================
# GOVCONNECT - UNIFIED DOCKER COMPOSE
# ===================================================================================
# 
# Semua services dalam 1 file dengan Docker Compose profiles
#
# USAGE:
# ┌─────────────────────────────────────────────────────────────────────────────────┐
# │ DEVELOPMENT (local):                                                            │
# │   docker compose up -d                                                          │
# │   → Otomatis load docker-compose.override.yml (NODE_ENV=development, DEV badge) │
# │                                                                                 │
# │ PRODUCTION (server):                                                            │
# │   docker compose -f docker-compose.yml --profile production \                   │
# │     --profile monitoring --profile logging up -d                                │
# │   → NODE_ENV=production, Traefik SSL, Full monitoring & logging                 │
# └─────────────────────────────────────────────────────────────────────────────────┘
#
# PROFILES:
#   - (default)    : Core services (postgres, rabbitmq, 5 microservices)
#   - monitoring   : Prometheus, Grafana, cAdvisor, Node Exporter, Alertmanager
#   - logging      : Loki, Promtail
#   - production   : Traefik API Gateway with SSL (Let's Encrypt)
#
# QUICK COMMANDS:
#   Dev only core:    docker compose up -d
#   Dev + monitoring: docker compose --profile monitoring up -d  
#   Production full:  docker compose -f docker-compose.yml --profile production --profile monitoring --profile logging up -d
#
# ===================================================================================

services:
  # ===================================================================================
  # INFRASTRUCTURE - Always Running
  # ===================================================================================

  # PostgreSQL with pgvector
  postgres:
    image: pgvector/pgvector:pg16
    container_name: govconnect-postgres
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
    environment:
      POSTGRES_DB: govconnect
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres_secret_2025}
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./docker/init-databases.sql:/docker-entrypoint-initdb.d/01-init.sql
      - ./docker/init-pg-hba.sh:/docker-entrypoint-initdb.d/02-init-pg-hba.sh
    networks:
      - govconnect-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d govconnect"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: govconnect-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq_secret_2025}
      RABBITMQ_DEFAULT_VHOST: govconnect
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./docker/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./docker/definitions.json:/etc/rabbitmq/definitions.json:ro
    networks:
      - govconnect-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===================================================================================
  # CORE MICROSERVICES
  # ===================================================================================

  # Service 1: Channel Service (WhatsApp Gateway)
  channel-service:
    build:
      context: ./govconnect-channel-service
      dockerfile: Dockerfile
    container_name: govconnect-channel-service
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3001
      SERVICE_NAME: channel-service
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres_secret_2025}@postgres:5432/govconnect?schema=channel
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-rabbitmq_secret_2025}@rabbitmq:5672/govconnect
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-govconnect-internal-2025-secret}
      WA_WEBHOOK_VERIFY_TOKEN: ${WA_WEBHOOK_VERIFY_TOKEN:-govconnect_verify_token_2025}
      WA_API_URL: ${WA_API_URL:-https://api-wa.genfity.com/wa}
      WA_ACCESS_TOKEN: ${WA_ACCESS_TOKEN:-govconnect}
      CASE_SERVICE_URL: http://case-service:3003
      NOTIFICATION_SERVICE_URL: http://notification-service:3004
      MEDIA_STORAGE_PATH: /app/uploads
      MEDIA_INTERNAL_URL: http://channel-service:3001/uploads
      MEDIA_PUBLIC_URL: ${MEDIA_PUBLIC_URL:-http://localhost:3001/uploads}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      - channel-uploads:/app/uploads
    networks:
      - govconnect-network
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.channel.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/channel`)"
      - "traefik.http.routers.channel.entrypoints=websecure"
      - "traefik.http.routers.channel.tls.certresolver=letsencrypt"
      - "traefik.http.services.channel.loadbalancer.server.port=3001"

  # Service 2: AI Orchestrator (Stateless)
  ai-service:
    build:
      context: ./govconnect-ai-service
      dockerfile: Dockerfile
    container_name: govconnect-ai-service
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3002
      SERVICE_NAME: ai-service
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-rabbitmq_secret_2025}@rabbitmq:5672/govconnect
      CHANNEL_SERVICE_URL: http://channel-service:3001
      CASE_SERVICE_URL: http://case-service:3003
      DASHBOARD_SERVICE_URL: http://dashboard:3000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-govconnect-internal-2025-secret}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE:-0.3}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS:-2000}
      LLM_TIMEOUT_MS: ${LLM_TIMEOUT_MS:-30000}
      MAX_HISTORY_MESSAGES: 30
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      - ai-service-data:/app/data
    networks:
      - govconnect-network
    depends_on:
      rabbitmq:
        condition: service_healthy
      channel-service:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ai.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/ai`)"
      - "traefik.http.routers.ai.entrypoints=websecure"
      - "traefik.http.routers.ai.tls.certresolver=letsencrypt"
      - "traefik.http.services.ai.loadbalancer.server.port=3002"

  # Service 3: Case Service (Laporan & Tiket)
  case-service:
    build:
      context: ./govconnect-case-service
      dockerfile: Dockerfile
    container_name: govconnect-case-service
    ports:
      - "3003:3003"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3003
      SERVICE_NAME: case-service
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres_secret_2025}@postgres:5432/govconnect?schema=cases
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-rabbitmq_secret_2025}@rabbitmq:5672/govconnect
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-govconnect-internal-2025-secret}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - govconnect-network
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.case.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/case`)"
      - "traefik.http.routers.case.entrypoints=websecure"
      - "traefik.http.routers.case.tls.certresolver=letsencrypt"
      - "traefik.http.services.case.loadbalancer.server.port=3003"

  # Service 4: Dashboard (Next.js)
  dashboard:
    build:
      context: ./govconnect-dashboard
      dockerfile: Dockerfile
    container_name: govconnect-dashboard
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres_secret_2025}@postgres:5432/govconnect?schema=dashboard
      JWT_SECRET: ${JWT_SECRET:-govconnect-jwt-secret-2025-change-in-production}
      CASE_SERVICE_URL: http://case-service:3003
      CHANNEL_SERVICE_URL: http://channel-service:3001
      AI_SERVICE_URL: http://ai-service:3002
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-govconnect-internal-2025-secret}
      NEXT_PUBLIC_APP_NAME: "GovConnect Dashboard"
    networks:
      - govconnect-network
    depends_on:
      postgres:
        condition: service_healthy
      case-service:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`govconnect.my.id`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.services.dashboard.loadbalancer.server.port=3000"

  # Service 5: Notification Service
  notification-service:
    build:
      context: ./govconnect-notification-service
      dockerfile: Dockerfile
    container_name: govconnect-notification-service
    ports:
      - "3004:3004"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 3004
      SERVICE_NAME: notification-service
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres_secret_2025}@postgres:5432/govconnect?schema=notification
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-admin}:${RABBITMQ_PASSWORD:-rabbitmq_secret_2025}@rabbitmq:5672/govconnect
      CHANNEL_SERVICE_URL: http://channel-service:3001
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-govconnect-internal-2025-secret}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    networks:
      - govconnect-network
    depends_on:
      postgres:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      channel-service:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.notification.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/notification`)"
      - "traefik.http.routers.notification.entrypoints=websecure"
      - "traefik.http.routers.notification.tls.certresolver=letsencrypt"
      - "traefik.http.services.notification.loadbalancer.server.port=3004"

  # ===================================================================================
  # MONITORING STACK (--profile monitoring)
  # ===================================================================================

  prometheus:
    image: prom/prometheus:v2.50.1
    container_name: govconnect-prometheus
    profiles: ["monitoring"]
    ports:
      - "9090:9090"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--storage.tsdb.retention.time=15d'
    networks:
      - govconnect-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.govconnect.my.id`)"
      - "traefik.http.routers.prometheus.entrypoints=websecure"
      - "traefik.http.routers.prometheus.tls.certresolver=letsencrypt"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"

  grafana:
    image: grafana/grafana:10.3.3
    container_name: govconnect-grafana
    profiles: ["monitoring"]
    ports:
      - "3100:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-govconnect-grafana-2025}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: ${GRAFANA_URL:-http://localhost:3100}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./docker/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - govconnect-network
    depends_on:
      - prometheus
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.govconnect.my.id`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=letsencrypt"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: govconnect-node-exporter
    profiles: ["monitoring"]
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - govconnect-network
    restart: unless-stopped

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.47.2
    container_name: govconnect-cadvisor
    profiles: ["monitoring"]
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    privileged: true
    networks:
      - govconnect-network
    restart: unless-stopped

  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: govconnect-alertmanager
    profiles: ["monitoring"]
    ports:
      - "9093:9093"
    volumes:
      - ./docker/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - govconnect-network
    restart: unless-stopped

  # ===================================================================================
  # LOGGING STACK (--profile logging)
  # ===================================================================================

  loki:
    image: grafana/loki:2.9.4
    container_name: govconnect-loki
    profiles: ["logging"]
    ports:
      - "3101:3100"
    volumes:
      - ./docker/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - govconnect-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  promtail:
    image: grafana/promtail:2.9.4
    container_name: govconnect-promtail
    profiles: ["logging"]
    volumes:
      - ./docker/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - govconnect-network
    depends_on:
      loki:
        condition: service_healthy
    restart: unless-stopped

  # ===================================================================================
  # PRODUCTION - TRAEFIK API GATEWAY (--profile production)
  # ===================================================================================

  traefik:
    image: traefik:v3.0
    container_name: govconnect-traefik
    profiles: ["production"]
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    command:
      - "--api.dashboard=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=govconnect-network"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@govconnect.my.id}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--metrics.prometheus=true"
      - "--accesslog=true"
      - "--log.level=INFO"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-certs:/letsencrypt
      - ./traefik/traefik.yaml:/etc/traefik/traefik.yaml:ro
    networks:
      - govconnect-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.govconnect.my.id`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"

# ===================================================================================
# NETWORKS
# ===================================================================================
networks:
  govconnect-network:
    driver: bridge
    name: govconnect-network

# ===================================================================================
# VOLUMES
# ===================================================================================
volumes:
  # Core
  pgdata:
    name: govconnect-pgdata
  rabbitmq-data:
    name: govconnect-rabbitmq-data
  channel-uploads:
    name: govconnect-channel-uploads
  ai-service-data:
    name: govconnect-ai-service-data
  
  # Monitoring
  prometheus-data:
    name: govconnect-prometheus-data
  grafana-data:
    name: govconnect-grafana-data
  alertmanager-data:
    name: govconnect-alertmanager-data
  
  # Logging
  loki-data:
    name: govconnect-loki-data
  
  # Production
  traefik-certs:
    name: govconnect-traefik-certs
