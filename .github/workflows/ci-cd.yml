# ===================================================================================
# GOVCONNECT - CI/CD PIPELINE
# ===================================================================================
# 
# Build all services and deploy to VPS using Docker Compose
# Triggers on push to main branch or manual dispatch
#
# Required Secrets:
#   - GHCR_TOKEN: GitHub Container Registry token (PAT)
#   - VPS_HOST: VPS IP address
#   - VPS_USER: SSH username
#   - VPS_SSH_KEY: SSH private key
#   - ENV_FILE: (Optional) Environment file contents
#
# ===================================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (all, dashboard, channel, ai, case, notification)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dashboard
          - channel-service
          - ai-service
          - case-service
          - notification-service
      deploy_only:
        description: 'Skip build, deploy existing image'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/govconnect

jobs:
  # ===================================================================================
  # DETECT CHANGES
  # ===================================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      dashboard: ${{ steps.filter.outputs.dashboard }}
      channel: ${{ steps.filter.outputs.channel }}
      ai: ${{ steps.filter.outputs.ai }}
      case: ${{ steps.filter.outputs.case }}
      notification: ${{ steps.filter.outputs.notification }}
      shared: ${{ steps.filter.outputs.shared }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dashboard:
              - 'govconnect-dashboard/**'
              - 'shared/**'
            channel:
              - 'govconnect-channel-service/**'
              - 'shared/**'
            ai:
              - 'govconnect-ai-service/**'
              - 'shared/**'
            case:
              - 'govconnect-case-service/**'
              - 'shared/**'
            notification:
              - 'govconnect-notification-service/**'
              - 'shared/**'
            shared:
              - 'shared/**'

  # ===================================================================================
  # LEGACY TERMS CHECK (Docs & Metadata)
  # ===================================================================================
  legacy-terms-check:
    name: Check Legacy Terms
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan docs and metadata for legacy terms
        shell: bash
        run: |
          set -euo pipefail
          PATTERN='reservasi|reservation|tiket|ticket|telegram|graphql'
          TARGETS=(
            "README.md"
            "docs"
            "govconnect-dashboard/app"
            "govconnect-dashboard/lib"
            "govconnect-dashboard/public"
            "govconnect-ai-service/docs"
            "govconnect-case-service/README.md"
            "govconnect-notification-service/README.md"
          )

          found=0
          for target in "${TARGETS[@]}"; do
            if [ -e "$target" ]; then
              if grep -RInE "$PATTERN" "$target" \
                --exclude-dir node_modules \
                --exclude-dir .next \
                --exclude-dir dist \
                --exclude-dir .github \
                --exclude "*.lock"; then
                found=1
              fi
            fi
          done

          if [ "$found" -eq 1 ]; then
            echo "Legacy terms ditemukan. Harap bersihkan sebelum merge."
            exit 1
          fi

  # ===================================================================================
  # BUILD DASHBOARD
  # ===================================================================================
  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      github.event.inputs.deploy_only != 'true' && 
      (needs.changes.outputs.dashboard == 'true' || 
       needs.changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'dashboard')
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-dashboard
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dashboard:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dashboard:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # BUILD CHANNEL SERVICE
  # ===================================================================================
  build-channel:
    name: Build Channel Service
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      github.event.inputs.deploy_only != 'true' && 
      (needs.changes.outputs.channel == 'true' || 
       needs.changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'channel-service')
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-channel-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-channel-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-channel-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # BUILD AI SERVICE
  # ===================================================================================
  build-ai:
    name: Build AI Service
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      github.event.inputs.deploy_only != 'true' && 
      (needs.changes.outputs.ai == 'true' || 
       needs.changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'ai-service')
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-ai-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ai-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ai-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # BUILD CASE SERVICE
  # ===================================================================================
  build-case:
    name: Build Case Service
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      github.event.inputs.deploy_only != 'true' && 
      (needs.changes.outputs.case == 'true' || 
       needs.changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'case-service')
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-case-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-case-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-case-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # BUILD NOTIFICATION SERVICE
  # ===================================================================================
  build-notification:
    name: Build Notification Service
    runs-on: ubuntu-latest
    needs: [changes]
    if: |
      github.event.inputs.deploy_only != 'true' && 
      (needs.changes.outputs.notification == 'true' || 
       needs.changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'notification-service')
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-notification-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-notification-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-notification-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # DEPLOY TO VPS
  # ===================================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build-dashboard, build-channel, build-ai, build-case, build-notification]
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      (needs.build-dashboard.result == 'success' || needs.build-dashboard.result == 'skipped') &&
      (needs.build-channel.result == 'success' || needs.build-channel.result == 'skipped') &&
      (needs.build-ai.result == 'success' || needs.build-ai.result == 'skipped') &&
      (needs.build-case.result == 'success' || needs.build-case.result == 'skipped') &&
      (needs.build-notification.result == 'success' || needs.build-notification.result == 'skipped')
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Log secrets usage
        run: |
          echo "üìã Secrets used in this workflow:"
          echo "  - VPS_HOST: ${{ secrets.VPS_HOST && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - VPS_USER: ${{ secrets.VPS_USER && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - GHCR_TOKEN: ${{ secrets.GHCR_TOKEN && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - ENV_FILE: ${{ secrets.ENV_FILE && '‚úÖ Set' || '‚ùå Not set' }}"

      - name: Update ENV file on server
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          if [ -n "$ENV_FILE" ]; then
            echo "üìù Updating .env file on server..."
            ssh $VPS_USER@$VPS_HOST "mkdir -p ~/genfity/govconnect"
            echo "$ENV_FILE" | ssh $VPS_USER@$VPS_HOST "cat > ~/genfity/govconnect/.env"
            echo "‚úÖ ENV file updated!"
          else
            echo "‚è≠Ô∏è ENV_FILE secret not set, skipping .env update"
          fi

      - name: Deploy with Docker Compose
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          echo "üöÄ Deploying GovConnect to VPS..."
          
          ssh $VPS_USER@$VPS_HOST << ENDSSH
            cd ~/genfity/govconnect
            
            # Force pull latest changes (override local, no conflicts)
            git fetch origin main
            git reset --hard origin/main
            
            # Login to GHCR using PAT
            echo "$GHCR_TOKEN" | sudo docker login ghcr.io -u mygads --password-stdin
            
            # Create networks if not exists
            sudo docker network create govconnect-network 2>/dev/null || true
            sudo docker network create infra-network 2>/dev/null || true
            
            # Set image variables and deploy using docker compose
            export IMAGE_DASHBOARD=ghcr.io/mygads/govconnect-dashboard:latest
            export IMAGE_CHANNEL=ghcr.io/mygads/govconnect-channel-service:latest
            export IMAGE_AI=ghcr.io/mygads/govconnect-ai-service:latest
            export IMAGE_CASE=ghcr.io/mygads/govconnect-case-service:latest
            export IMAGE_NOTIFICATION=ghcr.io/mygads/govconnect-notification-service:latest
            
            # Pull all images first (parallel)
            sudo -E docker compose pull
            
            # Stop old containers gracefully
            sudo -E docker compose down --remove-orphans || true
            
            # Start services sequentially to avoid memory spike
            echo "Starting channel-service..."
            sudo -E docker compose up -d channel-service
            sleep 10
            
            echo "Starting case-service..."
            sudo -E docker compose up -d case-service
            sleep 5
            
            echo "Starting notification-service..."
            sudo -E docker compose up -d notification-service
            sleep 5
            
            echo "Starting ai-service..."
            sudo -E docker compose up -d ai-service
            sleep 10
            
            echo "Starting dashboard..."
            sudo -E docker compose up -d dashboard
            sleep 5
            
            # Cleanup old images
            echo "üßπ Cleaning up..."
            sudo docker image prune -af --filter "until=24h" 2>/dev/null || true
            
            echo "‚úÖ Deployment complete!"
          ENDSSH

      - name: Run Database Migrations
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üóÉÔ∏è Running database migrations..."
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            # Wait for containers to be ready
            sleep 15
            
            # Create databases if they don't exist
            sudo -u postgres psql << 'EOSQL'
CREATE DATABASE IF NOT EXISTS gc_dashboard;
CREATE DATABASE IF NOT EXISTS gc_channel;
CREATE DATABASE IF NOT EXISTS gc_ai;
CREATE DATABASE IF NOT EXISTS gc_case;
CREATE DATABASE IF NOT EXISTS gc_notification;
EOSQL
            
            # Get DATABASE_URL from .env
            cd ~/genfity/govconnect
            
            # Run migrations for dashboard (has Prisma)
            if [ -d "govconnect-dashboard/prisma" ]; then
              echo "üì¶ Running Dashboard migrations..."
              DATABASE_URL="postgresql://postgres:Genfity@2025@172.17.0.1:6432/gc_dashboard"
              
              sudo docker run --rm \
                --network govconnect-network \
                --network infra-network \
                -e DATABASE_URL="$DATABASE_URL" \
                -v "$PWD/govconnect-dashboard/prisma":/app/prisma:ro \
                -w /app \
                node:22-alpine sh -c "
                  npm install prisma@latest --silent 2>/dev/null
                  
                  # Try migrate deploy first (for existing migrations)
                  echo 'Attempting prisma migrate deploy...'
                  npx prisma migrate deploy 2>&1 && exit 0
                  
                  # If failed, check if we need initial db push
                  echo 'migrate deploy returned non-zero, checking migration state...'
                  npx prisma migrate status 2>&1 || {
                    echo 'No migrations applied yet, running db push for initial schema...'
                    npx prisma db push 2>&1
                  }
                " || echo "‚ö†Ô∏è Dashboard migration completed with warnings"
            fi
            
            echo "‚úÖ Database migrations complete!"
          ENDSSH

      - name: Health Check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üè• Running health checks..."
          sleep 30
          
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "Checking services..."
            
            # Check Dashboard
            curl -sf http://localhost:3011/api/health && echo "‚úÖ Dashboard OK" || echo "‚ùå Dashboard FAILED"
            
            # Check Channel Service
            curl -sf http://localhost:3001/health && echo "‚úÖ Channel OK" || echo "‚ùå Channel FAILED"
            
            # Check AI Service
            curl -sf http://localhost:3002/health && echo "‚úÖ AI OK" || echo "‚ùå AI FAILED"
            
            # Check Case Service
            curl -sf http://localhost:3003/health && echo "‚úÖ Case OK" || echo "‚ùå Case FAILED"
            
            # Check Notification Service
            curl -sf http://localhost:3004/health && echo "‚úÖ Notification OK" || echo "‚ùå Notification FAILED"
            
            # Show container status and memory usage
            echo ""
            echo "Container Status:"
            sudo docker compose ps
            
            echo ""
            echo "Memory Usage:"
            sudo docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}" | grep govconnect
          ENDSSH

      - name: Generate summary
        if: success()
        run: |
          echo "## üöÄ GovConnect Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services Deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard: https://govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Case Service: https://case.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Channel Service: https://channel.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- AI Service: https://ai.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Notification Service: https://notification.govconnect.my.id" >> $GITHUB_STEP_SUMMARY

  # ===================================================================================
  # CLEANUP JOB (Runs regardless of success/failure)
  # ===================================================================================
  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Cleanup server
        continue-on-error: true
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "üßπ Running scheduled cleanup..."
            sudo docker system prune -f --filter "until=24h"
            echo "‚úÖ Cleanup complete!"
          ENDSSH
