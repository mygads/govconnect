# ===================================================================================
# GOVCONNECT - CI/CD PIPELINE
# ===================================================================================
#
# Build and deploy using docker compose
# Config deployment ada di docker-compose.yml (single source of truth)
#
# Required Secrets:
#   - GHCR_TOKEN: GitHub Container Registry token
#   - VPS_HOST, VPS_USER, VPS_SSH_KEY: SSH access
#   - ENV_FILE: Production .env content
#
# ===================================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_only:
        description: 'Skip build, deploy existing images'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/govconnect

jobs:
  # ===================================================================================
  # BUILD JOBS
  # ===================================================================================
  build:
    name: Build & Push Images
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_only != 'true' }}
    permissions:
      contents: read
      packages: write
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - name: dashboard
            context: ./govconnect-dashboard
          - name: channel-service
            context: ./govconnect-channel-service
          - name: ai-service
            context: ./govconnect-ai-service
          - name: case-service
            context: ./govconnect-case-service
          - name: notification-service
            context: ./govconnect-notification-service

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service.name }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service.name }}:${{ github.sha }}
          cache-from: type=gha,scope=${{ matrix.service.name }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service.name }}
          build-args: |
            NODE_ENV=production

  # ===================================================================================
  # DEPLOY TO VPS
  # ===================================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      always() && 
      (needs.build.result == 'success' || github.event.inputs.deploy_only == 'true') &&
      github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Log secrets usage
        run: |
          echo "üìã Secrets used in this workflow:"
          echo "  - VPS_HOST: ${{ secrets.VPS_HOST && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - VPS_USER: ${{ secrets.VPS_USER && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - GHCR_TOKEN: ${{ secrets.GHCR_TOKEN && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - ENV_FILE: ${{ secrets.ENV_FILE && '‚úÖ Set' || '‚ùå Not set' }}"

      - name: Update ENV file on server
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          if [ -n "$ENV_FILE" ]; then
            echo "üìù Updating .env file on server..."
            ssh $VPS_USER@$VPS_HOST "mkdir -p ~/genfity/govconnect"
            echo "$ENV_FILE" | ssh $VPS_USER@$VPS_HOST "cat > ~/genfity/govconnect/.env"
            echo "‚úÖ ENV file updated!"
          else
            echo "‚è≠Ô∏è ENV_FILE secret not set, skipping .env update"
          fi

      - name: Deploy with Docker Compose
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          echo "ÔøΩ Deployging GovConnect to VPS..."
          
          ssh $VPS_USER@$VPS_HOST << ENDSSH
            set -e
            cd ~/genfity/govconnect
            
            # Force pull latest changes (override local, no conflicts)
            git fetch origin main
            git reset --hard origin/main
            
            # Login to GHCR using PAT
            echo "$GHCR_TOKEN" | sudo docker login ghcr.io -u mygads --password-stdin
            
            # Set image variables for all services
            export IMAGE_DASHBOARD=ghcr.io/mygads/govconnect-dashboard:latest
            export IMAGE_CHANNEL=ghcr.io/mygads/govconnect-channel-service:latest
            export IMAGE_AI=ghcr.io/mygads/govconnect-ai-service:latest
            export IMAGE_CASE=ghcr.io/mygads/govconnect-case-service:latest
            export IMAGE_NOTIFICATION=ghcr.io/mygads/govconnect-notification-service:latest
            
            # Pull all images first (parallel) with retry
            echo "üì• Pulling images..."
            for i in {1..3}; do
              sudo -E docker compose pull && break || {
                echo "Pull attempt \$i failed, retrying..."
                sleep 10
              }
            done
            
            # Stop old containers gracefully
            echo "üõë Stopping old containers..."
            sudo -E docker compose down --remove-orphans || true
            
            # Start all services
            echo "üöÄ Starting all services..."
            sudo -E docker compose up -d --force-recreate
            
            # Wait for services to start
            sleep 30
            
            # Check container status
            echo "üìä Container status:"
            sudo docker compose ps
            
            # Cleanup old images
            echo "üßπ Cleaning up..."
            sudo docker image prune -af --filter "until=24h" 2>/dev/null || true
            
            echo "‚úÖ Deployment complete!"
          ENDSSH

      - name: Run Database Migrations
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üóÉÔ∏è Running database migrations..."
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            # Wait for containers to be ready
            echo "‚è≥ Waiting for containers to be ready..."
            sleep 20
            
            # Check if PostgreSQL is accessible
            echo "üîç Checking PostgreSQL connection..."
            if ! sudo -u postgres psql -c '\l' >/dev/null 2>&1; then
              echo "‚ùå PostgreSQL not accessible, skipping migrations"
              exit 0
            fi
            
            # Create databases if they don't exist
            echo "üì¶ Creating databases..."
            sudo -u postgres createdb gc_dashboard 2>/dev/null || echo "Database gc_dashboard already exists"
            sudo -u postgres createdb gc_channel 2>/dev/null || echo "Database gc_channel already exists"
            sudo -u postgres createdb gc_ai 2>/dev/null || echo "Database gc_ai already exists"
            sudo -u postgres createdb gc_case 2>/dev/null || echo "Database gc_case already exists"
            sudo -u postgres createdb gc_notification 2>/dev/null || echo "Database gc_notification already exists"
            
            cd ~/genfity/govconnect
            
            # Run migrations for dashboard (has Prisma)
            if sudo docker compose ps dashboard | grep -q "running"; then
              echo "üì¶ Running Dashboard migrations..."
              sudo docker compose exec dashboard sh -c "npx prisma migrate deploy || npx prisma db push --accept-data-loss" || echo "‚ö†Ô∏è Dashboard migration completed with warnings"
            fi
            
            # Run migrations for other services if they have Prisma
            for service in channel-service ai-service case-service notification-service; do
              if sudo docker compose ps \$service | grep -q "running"; then
                echo "üì¶ Running \$service migrations..."
                sudo docker compose exec \$service sh -c "npx prisma migrate deploy || npx prisma db push --accept-data-loss" || echo "‚ö†Ô∏è \$service migration completed with warnings"
              fi
            done
            
            echo "‚úÖ Database migrations complete!"
          ENDSSH

      - name: Health Check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üè• Running health checks..."
          sleep 30
          
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "Checking services..."
            
            # Check Dashboard
            curl -sf http://localhost:3011/api/health && echo "‚úÖ Dashboard OK" || echo "‚ùå Dashboard FAILED"
            
            # Check Channel Service
            curl -sf http://localhost:3001/health && echo "‚úÖ Channel OK" || echo "‚ùå Channel FAILED"
            
            # Check AI Service
            curl -sf http://localhost:3002/health && echo "‚úÖ AI OK" || echo "‚ùå AI FAILED"
            
            # Check Case Service
            curl -sf http://localhost:3003/health && echo "‚úÖ Case OK" || echo "‚ùå Case FAILED"
            
            # Check Notification Service
            curl -sf http://localhost:3004/health && echo "‚úÖ Notification OK" || echo "‚ùå Notification FAILED"
            
            # Show container status and memory usage
            echo ""
            echo "Container Status:"
            sudo docker compose ps
            
            echo ""
            echo "Memory Usage:"
            sudo docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}" | grep govconnect || true
          ENDSSH

      - name: Generate deployment summary
        if: success()
        run: |
          echo "## üöÄ GovConnect Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services Deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard: https://govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Case Service: https://case.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Channel Service: https://channel.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- AI Service: https://ai.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Notification Service: https://notification.govconnect.my.id" >> $GITHUB_STEP_SUMMARY

  # ===================================================================================
  # CLEANUP JOB (Runs regardless of success/failure)
  # ===================================================================================
  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Cleanup server
        continue-on-error: true
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "üßπ Running scheduled cleanup..."
            sudo docker system prune -f --filter "until=24h"
            echo "‚úÖ Cleanup complete!"
          ENDSSH