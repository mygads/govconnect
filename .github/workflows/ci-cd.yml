# ===================================================================================
# GOVCONNECT - CI/CD PIPELINE (CLEAN VERSION)
# ===================================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - dashboard
          - channel-service
          - ai-service
          - case-service
          - notification-service

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/govconnect

jobs:
  # ===================================================================================
  # BUILD DASHBOARD
  # ===================================================================================
  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-dashboard
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dashboard:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dashboard:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_APP_URL=https://govconnect.my.id

  # ===================================================================================
  # BUILD CHANNEL SERVICE
  # ===================================================================================
  build-channel:
    name: Build Channel Service
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-channel-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-channel-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-channel-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # BUILD AI SERVICE
  # ===================================================================================
  build-ai:
    name: Build AI Service
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-ai-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ai-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ai-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # BUILD CASE SERVICE
  # ===================================================================================
  build-case:
    name: Build Case Service
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-case-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-case-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-case-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # BUILD NOTIFICATION SERVICE
  # ===================================================================================
  build-notification:
    name: Build Notification Service
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-notification-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-notification-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-notification-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ===================================================================================
  # DEPLOY TO VPS
  # ===================================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [build-dashboard, build-channel, build-ai, build-case, build-notification]
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      (needs.build-dashboard.result == 'success' || needs.build-dashboard.result == 'skipped') &&
      (needs.build-channel.result == 'success' || needs.build-channel.result == 'skipped') &&
      (needs.build-ai.result == 'success' || needs.build-ai.result == 'skipped') &&
      (needs.build-case.result == 'success' || needs.build-case.result == 'skipped') &&
      (needs.build-notification.result == 'success' || needs.build-notification.result == 'skipped')
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          echo "üîç Validating required secrets..."
          
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå VPS_HOST secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ùå VPS_USER secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ùå VPS_SSH_KEY secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.GHCR_TOKEN }}" ]; then
            echo "‚ùå GHCR_TOKEN secret is not set"
            exit 1
          fi
          
          echo "‚úÖ All required secrets are set"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üîó Testing SSH connection..."
          ssh -o ConnectTimeout=10 $VPS_USER@$VPS_HOST "echo 'SSH connection successful'" || {
            echo "‚ùå SSH connection failed"
            exit 1
          }

      - name: Update ENV file on server
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          if [ -n "$ENV_FILE" ]; then
            echo "üìù Updating .env file on server..."
            ssh $VPS_USER@$VPS_HOST "mkdir -p ~/genfity/govconnect"
            echo "$ENV_FILE" | ssh $VPS_USER@$VPS_HOST "cat > ~/genfity/govconnect/.env"
            echo "‚úÖ ENV file updated!"
          else
            echo "‚è≠Ô∏è ENV_FILE secret not set, skipping .env update"
          fi

      - name: Deploy with Docker Compose
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          echo "üöÄ Deploying GovConnect to VPS..."
          
          ssh $VPS_USER@$VPS_HOST << 'DEPLOY_SCRIPT'
            set -e
            cd ~/genfity/govconnect
            
            # Force pull latest changes
            git fetch origin main
            git reset --hard origin/main
            
            # Login to GHCR
            echo "$GHCR_TOKEN" | sudo docker login ghcr.io -u mygads --password-stdin
            
            # Create networks if not exists
            sudo docker network create govconnect-network 2>/dev/null || true
            sudo docker network create infra-network 2>/dev/null || true
            
            # Set image variables
            export IMAGE_DASHBOARD=ghcr.io/mygads/govconnect-dashboard:latest
            export IMAGE_CHANNEL=ghcr.io/mygads/govconnect-channel-service:latest
            export IMAGE_AI=ghcr.io/mygads/govconnect-ai-service:latest
            export IMAGE_CASE=ghcr.io/mygads/govconnect-case-service:latest
            export IMAGE_NOTIFICATION=ghcr.io/mygads/govconnect-notification-service:latest
            
            # Pull images with retry
            for i in {1..3}; do
              sudo -E docker compose pull && break || {
                echo "Pull attempt $i failed, retrying..."
                sleep 10
              }
            done
            
            # Stop old containers
            sudo -E docker compose down --remove-orphans || true
            
            # Start services sequentially
            echo "Starting channel-service..."
            sudo -E docker compose up -d channel-service
            sleep 15
            
            echo "Starting case-service..."
            sudo -E docker compose up -d case-service
            sleep 10
            
            echo "Starting notification-service..."
            sudo -E docker compose up -d notification-service
            sleep 10
            
            echo "Starting ai-service..."
            sudo -E docker compose up -d ai-service
            sleep 15
            
            echo "Starting dashboard..."
            sudo -E docker compose up -d dashboard
            sleep 10
            
            # Check status
            sudo docker compose ps
            
            # Cleanup
            sudo docker image prune -af --filter "until=24h" 2>/dev/null || true
            
            echo "‚úÖ Deployment complete!"
          DEPLOY_SCRIPT

      - name: Run Database Migrations
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üóÉÔ∏è Running database migrations..."
          ssh $VPS_USER@$VPS_HOST << 'MIGRATION_SCRIPT'
            set -e
            sleep 20
            
            # Check PostgreSQL
            if ! sudo -u postgres psql -c '\l' >/dev/null 2>&1; then
              echo "‚ùå PostgreSQL not accessible, skipping migrations"
              exit 0
            fi
            
            # Create databases
            sudo -u postgres createdb gc_dashboard 2>/dev/null || echo "Database gc_dashboard exists"
            sudo -u postgres createdb gc_channel 2>/dev/null || echo "Database gc_channel exists"
            sudo -u postgres createdb gc_ai 2>/dev/null || echo "Database gc_ai exists"
            sudo -u postgres createdb gc_case 2>/dev/null || echo "Database gc_case exists"
            sudo -u postgres createdb gc_notification 2>/dev/null || echo "Database gc_notification exists"
            
            cd ~/genfity/govconnect
            
            # Run dashboard migrations
            if [ -d "govconnect-dashboard/prisma" ]; then
              if sudo docker compose ps dashboard | grep -q "running"; then
                sudo docker exec govconnect-dashboard sh -c "npx prisma migrate deploy || npx prisma db push --accept-data-loss" || echo "‚ö†Ô∏è Migration completed with warnings"
              fi
            fi
            
            echo "‚úÖ Database migrations complete!"
          MIGRATION_SCRIPT

      - name: Health Check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üè• Running health checks..."
          sleep 30
          
          ssh $VPS_USER@$VPS_HOST << 'HEALTH_SCRIPT'
            echo "Checking services..."
            
            # Check services
            curl -sf http://localhost:3011/api/health && echo "‚úÖ Dashboard OK" || echo "‚ùå Dashboard FAILED"
            curl -sf http://localhost:3001/health && echo "‚úÖ Channel OK" || echo "‚ùå Channel FAILED"
            curl -sf http://localhost:3002/health && echo "‚úÖ AI OK" || echo "‚ùå AI FAILED"
            curl -sf http://localhost:3003/health && echo "‚úÖ Case OK" || echo "‚ùå Case FAILED"
            curl -sf http://localhost:3004/health && echo "‚úÖ Notification OK" || echo "‚ùå Notification FAILED"
            
            # Show status
            echo ""
            echo "Container Status:"
            sudo docker compose ps
          HEALTH_SCRIPT

      - name: Generate summary
        if: success()
        run: |
          echo "## üöÄ GovConnect Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services Deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard: https://govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Case Service: https://case.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Channel Service: https://channel.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- AI Service: https://ai.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Notification Service: https://notification.govconnect.my.id" >> $GITHUB_STEP_SUMMARY

  # ===================================================================================
  # CLEANUP JOB
  # ===================================================================================
  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Cleanup server
        continue-on-error: true
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'CLEANUP_SCRIPT'
            echo "üßπ Running scheduled cleanup..."
            sudo docker system prune -f --filter "until=24h"
            echo "‚úÖ Cleanup complete!"
          CLEANUP_SCRIPT