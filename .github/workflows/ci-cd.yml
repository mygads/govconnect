# ===================================================================================
# GOVCONNECT - CI/CD PIPELINE
# ===================================================================================
#
# Smart build: Only builds services that have changes
# Uses change detection to determine which services need rebuilding
#
# Required Secrets:
#   - GHCR_TOKEN: GitHub Container Registry token (PAT with read:packages)
#   - VPS_HOST, VPS_USER, VPS_SSH_KEY: SSH access
#   - ENV_FILE: Production .env content (optional)
#
# ===================================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_only:
        description: 'Skip build, deploy existing images'
        required: false
        default: 'false'
        type: boolean
      force_build_all:
        description: 'Force build all services'
        required: false
        default: 'false'
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/govconnect

jobs:
  # ===================================================================================
  # DETECT CHANGES - Determine which services need to be built
  # ===================================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_only != 'true' }}
    outputs:
      dashboard: ${{ steps.changes.outputs.dashboard }}
      channel-service: ${{ steps.changes.outputs.channel-service }}
      ai-service: ${{ steps.changes.outputs.ai-service }}
      case-service: ${{ steps.changes.outputs.case-service }}
      notification-service: ${{ steps.changes.outputs.notification-service }}
      any-changed: ${{ steps.changes.outputs.any-changed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          # Get the base commit for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
          else
            BASE_SHA=${{ github.event.before }}
            # Handle initial commit or force push
            if [ "$BASE_SHA" == "0000000000000000000000000000000000000000" ]; then
              BASE_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
            fi
          fi

          # Force build all if requested or if we can't determine base
          if [ "${{ github.event.inputs.force_build_all }}" == "true" ] || [ -z "$BASE_SHA" ]; then
            echo "Force building all services"
            echo "dashboard=true" >> $GITHUB_OUTPUT
            echo "channel-service=true" >> $GITHUB_OUTPUT
            echo "ai-service=true" >> $GITHUB_OUTPUT
            echo "case-service=true" >> $GITHUB_OUTPUT
            echo "notification-service=true" >> $GITHUB_OUTPUT
            echo "any-changed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Comparing $BASE_SHA to HEAD"

          # Check each service for changes
          check_changes() {
            local service=$1
            local path=$2
            if git diff --name-only $BASE_SHA HEAD | grep -q "^$path/"; then
              echo "true"
            else
              echo "false"
            fi
          }

          # Also check shared folder and root docker-compose for all services
          SHARED_CHANGED=$(git diff --name-only $BASE_SHA HEAD | grep -q "^shared/" && echo "true" || echo "false")
          COMPOSE_CHANGED=$(git diff --name-only $BASE_SHA HEAD | grep -q "^docker-compose.yml" && echo "true" || echo "false")

          # Dashboard
          DASHBOARD=$(check_changes "dashboard" "govconnect-dashboard")
          if [ "$SHARED_CHANGED" == "true" ] || [ "$COMPOSE_CHANGED" == "true" ]; then DASHBOARD="true"; fi
          echo "dashboard=$DASHBOARD" >> $GITHUB_OUTPUT
          echo "Dashboard changed: $DASHBOARD"

          # Channel Service
          CHANNEL=$(check_changes "channel-service" "govconnect-channel-service")
          if [ "$SHARED_CHANGED" == "true" ] || [ "$COMPOSE_CHANGED" == "true" ]; then CHANNEL="true"; fi
          echo "channel-service=$CHANNEL" >> $GITHUB_OUTPUT
          echo "Channel Service changed: $CHANNEL"

          # AI Service
          AI=$(check_changes "ai-service" "govconnect-ai-service")
          if [ "$SHARED_CHANGED" == "true" ] || [ "$COMPOSE_CHANGED" == "true" ]; then AI="true"; fi
          echo "ai-service=$AI" >> $GITHUB_OUTPUT
          echo "AI Service changed: $AI"

          # Case Service
          CASE=$(check_changes "case-service" "govconnect-case-service")
          if [ "$SHARED_CHANGED" == "true" ] || [ "$COMPOSE_CHANGED" == "true" ]; then CASE="true"; fi
          echo "case-service=$CASE" >> $GITHUB_OUTPUT
          echo "Case Service changed: $CASE"

          # Notification Service
          NOTIFICATION=$(check_changes "notification-service" "govconnect-notification-service")
          if [ "$SHARED_CHANGED" == "true" ] || [ "$COMPOSE_CHANGED" == "true" ]; then NOTIFICATION="true"; fi
          echo "notification-service=$NOTIFICATION" >> $GITHUB_OUTPUT
          echo "Notification Service changed: $NOTIFICATION"

          # Check if any service changed
          if [ "$DASHBOARD" == "true" ] || [ "$CHANNEL" == "true" ] || [ "$AI" == "true" ] || [ "$CASE" == "true" ] || [ "$NOTIFICATION" == "true" ]; then
            echo "any-changed=true" >> $GITHUB_OUTPUT
          else
            echo "any-changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate change summary
        run: |
          echo "## üîç Change Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dashboard | ${{ steps.changes.outputs.dashboard }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Channel Service | ${{ steps.changes.outputs.channel-service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Service | ${{ steps.changes.outputs.ai-service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Case Service | ${{ steps.changes.outputs.case-service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Notification Service | ${{ steps.changes.outputs.notification-service }} |" >> $GITHUB_STEP_SUMMARY

  # ===================================================================================
  # BUILD JOBS - Only build services that have changes
  # ===================================================================================
  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.dashboard == 'true' }}
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Dashboard
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-dashboard
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dashboard:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-dashboard:${{ github.sha }}
          cache-from: type=gha,scope=dashboard
          cache-to: type=gha,mode=max,scope=dashboard
          build-args: |
            NODE_ENV=production

  build-channel-service:
    name: Build Channel Service
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.channel-service == 'true' }}
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Channel Service
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-channel-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-channel-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-channel-service:${{ github.sha }}
          cache-from: type=gha,scope=channel-service
          cache-to: type=gha,mode=max,scope=channel-service
          build-args: |
            NODE_ENV=production

  build-ai-service:
    name: Build AI Service
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.ai-service == 'true' }}
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push AI Service
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-ai-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ai-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ai-service:${{ github.sha }}
          cache-from: type=gha,scope=ai-service
          cache-to: type=gha,mode=max,scope=ai-service
          build-args: |
            NODE_ENV=production

  build-case-service:
    name: Build Case Service
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.case-service == 'true' }}
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Case Service
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-case-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-case-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-case-service:${{ github.sha }}
          cache-from: type=gha,scope=case-service
          cache-to: type=gha,mode=max,scope=case-service
          build-args: |
            NODE_ENV=production

  build-notification-service:
    name: Build Notification Service
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: ${{ needs.detect-changes.outputs.notification-service == 'true' }}
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Notification Service
        uses: docker/build-push-action@v5
        with:
          context: ./govconnect-notification-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-notification-service:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-notification-service:${{ github.sha }}
          cache-from: type=gha,scope=notification-service
          cache-to: type=gha,mode=max,scope=notification-service
          build-args: |
            NODE_ENV=production

  # ===================================================================================
  # DEPLOY TO VPS
  # ===================================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: [detect-changes, build-dashboard, build-channel-service, build-ai-service, build-case-service, build-notification-service]
    # Deploy if at least one build succeeded (partial deployment allowed)
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      (github.event.inputs.deploy_only == 'true' || needs.detect-changes.outputs.any-changed == 'true') &&
      (needs.build-dashboard.result == 'success' || 
       needs.build-channel-service.result == 'success' || 
       needs.build-ai-service.result == 'success' || 
       needs.build-case-service.result == 'success' || 
       needs.build-notification-service.result == 'success' ||
       github.event.inputs.deploy_only == 'true')
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Log secrets usage
        run: |
          echo "üìã Secrets used in this workflow:"
          echo "  - VPS_HOST: ${{ secrets.VPS_HOST && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - VPS_USER: ${{ secrets.VPS_USER && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - GHCR_TOKEN: ${{ secrets.GHCR_TOKEN && '‚úÖ Set' || '‚ùå Not set' }}"
          echo "  - ENV_FILE: ${{ secrets.ENV_FILE && '‚úÖ Set' || '‚ùå Not set' }}"

      - name: Update ENV file on server
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
        run: |
          if [ -n "$ENV_FILE" ]; then
            echo "üìù Updating .env file on server..."
            ssh $VPS_USER@$VPS_HOST "mkdir -p ~/genfity/govconnect"
            echo "$ENV_FILE" | ssh $VPS_USER@$VPS_HOST "cat > ~/genfity/govconnect/.env"
            echo "‚úÖ ENV file updated!"
          else
            echo "‚è≠Ô∏è ENV_FILE secret not set, skipping .env update"
          fi

      - name: Deploy with Docker Compose
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          DASHBOARD_BUILD: ${{ needs.build-dashboard.result }}
          CHANNEL_BUILD: ${{ needs.build-channel-service.result }}
          AI_BUILD: ${{ needs.build-ai-service.result }}
          CASE_BUILD: ${{ needs.build-case-service.result }}
          NOTIFICATION_BUILD: ${{ needs.build-notification-service.result }}
        run: |
          echo "üöÄ Deploying GovConnect to VPS..."
          echo "üìä Build Results:"
          echo "  - Dashboard: $DASHBOARD_BUILD"
          echo "  - Channel: $CHANNEL_BUILD"
          echo "  - AI: $AI_BUILD"
          echo "  - Case: $CASE_BUILD"
          echo "  - Notification: $NOTIFICATION_BUILD"
          
          # Build list of services to recreate (only those that were built successfully)
          SERVICES_TO_RECREATE=""
          if [ "$DASHBOARD_BUILD" == "success" ]; then
            SERVICES_TO_RECREATE="$SERVICES_TO_RECREATE dashboard"
          fi
          if [ "$CHANNEL_BUILD" == "success" ]; then
            SERVICES_TO_RECREATE="$SERVICES_TO_RECREATE channel-service"
          fi
          if [ "$AI_BUILD" == "success" ]; then
            SERVICES_TO_RECREATE="$SERVICES_TO_RECREATE ai-service"
          fi
          if [ "$CASE_BUILD" == "success" ]; then
            SERVICES_TO_RECREATE="$SERVICES_TO_RECREATE case-service"
          fi
          if [ "$NOTIFICATION_BUILD" == "success" ]; then
            SERVICES_TO_RECREATE="$SERVICES_TO_RECREATE notification-service"
          fi
          
          echo "üì¶ Services to recreate: $SERVICES_TO_RECREATE"
          
          # Export for SSH
          export SERVICES_TO_RECREATE
          
          ssh $VPS_USER@$VPS_HOST "bash -s" << EOF
            set -e
            cd ~/genfity/govconnect
            
            SERVICES_TO_PULL="$SERVICES_TO_RECREATE"
            
            # Force pull latest changes (override local, no conflicts)
            git fetch origin main
            git reset --hard origin/main
            
            # Login to GHCR using PAT
            echo "$GHCR_TOKEN" | sudo docker login ghcr.io -u mygads --password-stdin
            
            # Set image variables for all services
            export IMAGE_DASHBOARD=ghcr.io/mygads/govconnect-dashboard:latest
            export IMAGE_CHANNEL=ghcr.io/mygads/govconnect-channel-service:latest
            export IMAGE_AI=ghcr.io/mygads/govconnect-ai-service:latest
            export IMAGE_CASE=ghcr.io/mygads/govconnect-case-service:latest
            export IMAGE_NOTIFICATION=ghcr.io/mygads/govconnect-notification-service:latest
            
            # Pull only images that were built successfully
            if [ -n "\$SERVICES_TO_PULL" ]; then
              echo "üì• Pulling images for: \$SERVICES_TO_PULL"
              sudo -E docker compose pull \$SERVICES_TO_PULL || true
              
              echo "üöÄ Recreating services: \$SERVICES_TO_PULL"
              sudo -E docker compose up -d --no-deps --force-recreate \$SERVICES_TO_PULL
            else
              echo "‚ö†Ô∏è No services to recreate, running all services"
              sudo -E docker compose pull --ignore-pull-failures || true
              sudo -E docker compose up -d
            fi
            
            # Wait for services to start
            sleep 15
            
            # Check container status
            echo "üìä Container status:"
            sudo docker compose ps
            
            echo "‚úÖ Deployment complete!"
          EOF

      - name: Run Database Migrations
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üóÉÔ∏è Running database migrations..."
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            # Wait for containers to be ready
            echo "‚è≥ Waiting for containers to be ready..."
            sleep 20
            
            # Check if PostgreSQL is accessible
            echo "üîç Checking PostgreSQL connection..."
            if ! sudo -u postgres psql -c '\l' >/dev/null 2>&1; then
              echo "‚ùå PostgreSQL not accessible, skipping migrations"
              exit 0
            fi
            
            # Create databases if they don't exist
            echo "üì¶ Creating databases..."
            sudo -u postgres createdb gc_dashboard 2>/dev/null || echo "Database gc_dashboard already exists"
            sudo -u postgres createdb gc_channel 2>/dev/null || echo "Database gc_channel already exists"
            sudo -u postgres createdb gc_ai 2>/dev/null || echo "Database gc_ai already exists"
            sudo -u postgres createdb gc_case 2>/dev/null || echo "Database gc_case already exists"
            sudo -u postgres createdb gc_notification 2>/dev/null || echo "Database gc_notification already exists"
            
            cd ~/genfity/govconnect
            
            # Run migrations for dashboard (has Prisma)
            if sudo docker compose ps dashboard | grep -q "running"; then
              echo "üì¶ Running Dashboard migrations..."
              sudo docker compose exec -T dashboard sh -c "npx prisma migrate deploy || npx prisma db push --accept-data-loss" 2>&1 || echo "‚ö†Ô∏è Dashboard migration completed with warnings"
            fi
            
            # Run migrations for other services if they have Prisma
            for service in channel-service ai-service case-service notification-service; do
              if sudo docker compose ps $service | grep -q "running"; then
                echo "üì¶ Running $service migrations..."
                sudo docker compose exec -T $service sh -c "npx prisma migrate deploy || npx prisma db push --accept-data-loss" 2>&1 || echo "‚ö†Ô∏è $service migration completed with warnings"
              fi
            done
            
            echo "‚úÖ Database migrations complete!"
          ENDSSH

      - name: Health Check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "üè• Running health checks..."
          sleep 30
          
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "Checking services..."
            
            # Check Dashboard
            curl -sf http://localhost:3011/api/health && echo " ‚úÖ Dashboard OK" || echo " ‚ùå Dashboard FAILED"
            
            # Check Channel Service
            curl -sf http://localhost:3001/health && echo " ‚úÖ Channel OK" || echo " ‚ùå Channel FAILED"
            
            # Check AI Service
            curl -sf http://localhost:3002/health && echo " ‚úÖ AI OK" || echo " ‚ùå AI FAILED"
            
            # Check Case Service
            curl -sf http://localhost:3003/health && echo " ‚úÖ Case OK" || echo " ‚ùå Case FAILED"
            
            # Check Notification Service
            curl -sf http://localhost:3004/health && echo " ‚úÖ Notification OK" || echo " ‚ùå Notification FAILED"
            
            # Show container status and memory usage
            echo ""
            echo "Container Status:"
            sudo docker compose ps
            
            echo ""
            echo "Memory Usage:"
            sudo docker stats --no-stream --format "table {{.Name}}\t{{.MemUsage}}" | grep govconnect || true
          ENDSSH

      - name: Generate deployment summary
        if: success()
        run: |
          echo "## üöÄ GovConnect Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Services Deployed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Dashboard: https://govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Channel Service: https://channel.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- AI Service: https://ai.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Case Service: https://case.govconnect.my.id" >> $GITHUB_STEP_SUMMARY
          echo "- Notification Service: https://notification.govconnect.my.id" >> $GITHUB_STEP_SUMMARY

  # ===================================================================================
  # CLEANUP JOB
  # ===================================================================================
  cleanup:
    name: Cleanup Old Resources
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always() && needs.deploy.result == 'success'
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Cleanup server
        continue-on-error: true
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            echo "üßπ Running scheduled cleanup..."
            sudo docker system prune -f --filter "until=24h"
            sudo docker image prune -af --filter "until=48h"
            echo "‚úÖ Cleanup complete!"
          ENDSSH
