# ==================== CHANNEL SERVICE ====================
#
# ENVIRONMENT MODES:
# ┌──────────────────────────────────────────────────────────────────────────┐
# │  MODE              │ SERVICE_URL PATTERN         │ DATABASE HOST         │
# ├──────────────────────────────────────────────────────────────────────────┤
# │  Local Dev (npm)   │ http://localhost:PORT       │ localhost:5432        │
# │  Docker Compose    │ http://service-name:PORT    │ postgres:5432         │
# │  Docker Swarm      │ http://service-name:PORT    │ postgres:5432         │
# └──────────────────────────────────────────────────────────────────────────┘
#
# This service handles:
# - WhatsApp webhook (receive messages)
# - Message storage (FIFO 30 messages per user)
# - Internal API for sending messages
# - Chat history API for AI context
# ============================================================================

# Node Environment
NODE_ENV=development
PORT=3001

# Database (Channel Service)
# Local Dev: localhost:5432
# Docker: infra-postgres:5432
DATABASE_URL=postgresql://postgres:genfity2025@infra-postgres:5432/gc_channel

# RabbitMQ
# Local Dev: localhost:5672
# Docker: rabbitmq:5672
RABBITMQ_URL=amqp://admin:genfityrabbitmq@rabbitmq:5672/govconnect

# Internal API Key (untuk auth antar service)
INTERNAL_API_KEY=govconnect-internal-2025-secret

# WhatsApp API (clivy-wa-support/genfity-wa)
# WA_API_URL is the base URL of WhatsApp gateway (harus include prefix `/v1/wa`)
# Direkomendasikan: pakai public gateway (genfity-wa-support).
WA_API_URL=https://api-wa.genfity.com/v1/wa

# (Opsional) Buat sesi via genfity-app customer-api (API key auth).
WA_SUPPORT_URL=http://localhost:8082
WA_SUPPORT_INTERNAL_API_KEY=govconnect:govconnect2026

# Verify token untuk webhook (opsional). Jika kosong, Channel Service akan menerima verifikasi tanpa token.
WA_WEBHOOK_VERIFY_TOKEN=

# IP allowlist untuk webhook WhatsApp (comma-separated)
# Hanya terima webhook dari IP yang terdaftar (defense-in-depth)
# Jika kosong, semua IP diterima (dev mode / behind trusted reverse proxy)
# Contoh: WEBHOOK_ALLOWED_IPS=104.21.32.1,172.67.180.1
WEBHOOK_ALLOWED_IPS=

# Jika true, Channel Service tidak akan mengirim request keluar ke WhatsApp provider
WA_DRY_RUN=false

# Public base URLs (untuk build webhook URL)
PUBLIC_BASE_URL=http://localhost:3000
PUBLIC_CHANNEL_BASE_URL=http://localhost:3001

# Logging
LOG_LEVEL=debug
LOG_DIR=logs

# ==================== MEDIA / UPLOADS ====================
# MEDIA_STORAGE_PATH: lokasi penyimpanan file di container
# MEDIA_INTERNAL_URL: base URL untuk akses media dari internal Docker network
# MEDIA_PUBLIC_URL: base URL yang bisa diakses publik (dipakai untuk URL yang dikirim ke user)
MEDIA_STORAGE_PATH=/app/uploads
MEDIA_INTERNAL_URL=http://channel-service:3001/uploads
MEDIA_PUBLIC_URL=http://localhost:3001/uploads

# ==================== INTERNAL SERVICE URLS ====================
# These are for internal service-to-service communication
# In Docker (Compose/Swarm): Use container names
# In Local Dev: Use localhost with respective ports
#
# ┌─────────────────────────────────────────────────────────────────────────────┐
# │  LOCAL DEVELOPMENT (npm run dev)                                            │
# │  ─────────────────────────────────────────────────────────────────────────  │
# │  CASE_SERVICE_URL=http://localhost:3003                                     │
# │  NOTIFICATION_SERVICE_URL=http://localhost:3004                             │
# ├─────────────────────────────────────────────────────────────────────────────┤
# │  DOCKER (Compose/Swarm) - Uses internal Docker network                      │
# │  ─────────────────────────────────────────────────────────────────────────  │
# │  CASE_SERVICE_URL=http://case-service:3003                                  │
# │  NOTIFICATION_SERVICE_URL=http://notification-service:3004                  │
# └─────────────────────────────────────────────────────────────────────────────┘
#
CASE_SERVICE_URL=http://localhost:3003
NOTIFICATION_SERVICE_URL=http://localhost:3004
AI_SERVICE_URL=http://localhost:3002

# ==================== SPAM GUARD ====================
# Proteksi spam: bubble chat, spam teks identik, rate spam
SPAM_GUARD_ENABLED=true
SPAM_GUARD_MAX_IDENTICAL=5
SPAM_GUARD_BAN_DURATION_MS=60000

# Rate spam: ban user jika >N pesan dalam M detik
SPAM_RATE_MAX_MESSAGES=10
SPAM_RATE_WINDOW_MS=10000
