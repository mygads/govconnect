// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ChannelType {
  WHATSAPP
  WEBCHAT
}

model Message {
  id           String   @id @default(cuid())
  village_id   String
  wa_user_id   String?  // 628xxx (WhatsApp user phone number)
  channel      ChannelType @default(WHATSAPP)
  channel_identifier String // WA: 628xxx | Webchat: session_id
  message_id   String   @unique // Unique message ID from WhatsApp provider
  message_text String   @db.Text
  direction    String   // "IN" | "OUT"
  source       String   // "WA_WEBHOOK" | "AI" | "SYSTEM"
  timestamp    DateTime @default(now())
  createdAt    DateTime @default(now())
  
  @@index([village_id, channel, channel_identifier, timestamp])
  @@index([channel, channel_identifier])
  @@index([direction])
  @@index([message_id])
  @@map("messages")
}

model SendLog {
  id           String   @id @default(cuid())
  village_id   String
  wa_user_id   String?
  channel      ChannelType @default(WHATSAPP)
  channel_identifier String
  message_text String   @db.Text
  status       String   // "sent" | "failed"
  error_msg    String?  @db.Text
  timestamp    DateTime @default(now())
  
  @@index([village_id, channel, channel_identifier])
  @@index([status])
  @@index([timestamp])
  @@map("send_logs")
}

model wa_settings {
  id                 String   @id @default("default")
  auto_read_messages Boolean  @default(false)
  typing_indicator   Boolean  @default(false)
  created_at         DateTime @default(now())
  updated_at         DateTime @default(now()) @updatedAt
  
  @@map("wa_settings")
}

model wa_sessions {
  id               String   @id @default(cuid())
  village_id       String   @unique
  instance_name    String?  @unique // Session name on WA provider (slug e.g. "desa-sanreseng-ade")
  admin_id         String?
  wa_token         String
  wa_number        String?
  status           String?
  last_connected_at DateTime?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  @@index([admin_id])
  @@index([village_id])
  @@map("wa_sessions")
}

// Channel accounts per village
model channel_accounts {
  id             String   @id @default(cuid())
  village_id     String   @unique
  wa_number      String
  wa_token       String
  webhook_url    String
  enabled_wa     Boolean  @default(false)
  enabled_webchat Boolean @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  @@index([wa_number])
  @@map("channel_accounts")
}

// Takeover sessions - when admin takes over conversation from AI
model TakeoverSession {
  id           String    @id @default(cuid())
  village_id   String
  wa_user_id   String?   // WhatsApp user number (nullable for webchat)
  channel      ChannelType @default(WHATSAPP)
  channel_identifier String // WA: 628xxx | Webchat: session_id
  admin_id     String    // Admin user ID who took over
  admin_name   String?   // Admin display name
  started_at   DateTime  @default(now())
  ended_at     DateTime? // null = still active
  reason       String?   // Optional reason for takeover
  
  @@index([village_id, channel, channel_identifier])
  @@index([admin_id])
  @@index([started_at])
  @@index([village_id, channel, channel_identifier, ended_at]) // For finding active takeover
  @@map("takeover_sessions")
}

// Conversation summary for live chat list
model Conversation {
  id                   String   @id @default(cuid())
  village_id           String
  wa_user_id           String?
  channel              ChannelType @default(WHATSAPP)
  channel_identifier   String
  user_name            String?  // Collected name or WhatsApp push name
  user_phone           String?  // Collected phone number (for webchat)
  last_message         String?  @db.Text
  last_message_at      DateTime @default(now())
  unread_count         Int      @default(0)
  is_takeover          Boolean  @default(false)
  ai_status            String?  // null | "processing" | "error" | "queued"
  ai_error_message     String?  @db.Text // Error message if AI failed
  pending_message_id   String?  // Message ID that needs AI retry
  created_at           DateTime @default(now())
  updated_at           DateTime @default(now()) @updatedAt
  
  @@unique([village_id, channel, channel_identifier])
  @@index([village_id])
  @@index([is_takeover])
  @@index([last_message_at])
  @@index([ai_status])
  @@map("conversations")
}

// Pending messages queue - for batching and retry
model PendingMessage {
  id           String   @id @default(cuid())
  village_id   String
  wa_user_id   String?  // WhatsApp user number (nullable for webchat)
  channel      ChannelType @default(WHATSAPP)
  channel_identifier String
  message_id   String   @unique // WhatsApp message ID
  message_text String   @db.Text
  status       String   @default("pending") // pending | processing | completed | failed
  retry_count  Int      @default(0)
  error_msg    String?  @db.Text
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now()) @updatedAt
  
  @@index([village_id, channel, channel_identifier, status])
  @@index([status, created_at])
  @@map("pending_messages")
}
