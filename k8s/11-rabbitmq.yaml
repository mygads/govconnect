# ==================== RABBITMQ STATEFULSET ====================
# Message broker for async communication between services

apiVersion: v1
kind: Service
metadata:
  name: rabbitmq
  namespace: govconnect
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: messaging
spec:
  type: ClusterIP
  ports:
    - port: 5672
      targetPort: 5672
      name: amqp
    - port: 15672
      targetPort: 15672
      name: management
  selector:
    app: rabbitmq

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: rabbitmq-pvc
  namespace: govconnect
  labels:
    app.kubernetes.io/name: rabbitmq
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi

---
# RabbitMQ Configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
  namespace: govconnect
  labels:
    app.kubernetes.io/name: rabbitmq
data:
  rabbitmq.conf: |
    # RabbitMQ Configuration for GovConnect
    default_vhost = govconnect
    default_user = admin
    
    # Memory settings
    vm_memory_high_watermark.relative = 0.7
    
    # Disk settings
    disk_free_limit.absolute = 1GB
    
    # Management plugin
    management.load_definitions = /etc/rabbitmq/definitions.json
    
    # Logging
    log.console = true
    log.console.level = info
  
  definitions.json: |
    {
      "users": [
        {
          "name": "admin",
          "password_hash": "BxJdvNbLDNYoQHNV/IyT7k5dVGHxRNHNPpyXaIXGfABGt4q4",
          "hashing_algorithm": "rabbit_password_hashing_sha256",
          "tags": ["administrator"]
        }
      ],
      "vhosts": [
        { "name": "govconnect" }
      ],
      "permissions": [
        {
          "user": "admin",
          "vhost": "govconnect",
          "configure": ".*",
          "write": ".*",
          "read": ".*"
        }
      ],
      "exchanges": [
        {
          "name": "govconnect.messages",
          "vhost": "govconnect",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "govconnect.cases",
          "vhost": "govconnect",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "govconnect.notifications",
          "vhost": "govconnect",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "govconnect.dlx",
          "vhost": "govconnect",
          "type": "topic",
          "durable": true,
          "auto_delete": false
        }
      ],
      "queues": [
        {
          "name": "incoming.messages",
          "vhost": "govconnect",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "govconnect.dlx",
            "x-dead-letter-routing-key": "dlq.messages"
          }
        },
        {
          "name": "ai.processing",
          "vhost": "govconnect",
          "durable": true,
          "auto_delete": false,
          "arguments": {
            "x-dead-letter-exchange": "govconnect.dlx",
            "x-dead-letter-routing-key": "dlq.ai"
          }
        },
        {
          "name": "case.updates",
          "vhost": "govconnect",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "notification.outbound",
          "vhost": "govconnect",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "dlq.messages",
          "vhost": "govconnect",
          "durable": true,
          "auto_delete": false
        },
        {
          "name": "dlq.ai",
          "vhost": "govconnect",
          "durable": true,
          "auto_delete": false
        }
      ],
      "bindings": [
        {
          "source": "govconnect.messages",
          "vhost": "govconnect",
          "destination": "incoming.messages",
          "destination_type": "queue",
          "routing_key": "message.incoming.#"
        },
        {
          "source": "govconnect.messages",
          "vhost": "govconnect",
          "destination": "ai.processing",
          "destination_type": "queue",
          "routing_key": "message.ai.#"
        },
        {
          "source": "govconnect.cases",
          "vhost": "govconnect",
          "destination": "case.updates",
          "destination_type": "queue",
          "routing_key": "case.#"
        },
        {
          "source": "govconnect.notifications",
          "vhost": "govconnect",
          "destination": "notification.outbound",
          "destination_type": "queue",
          "routing_key": "notification.#"
        },
        {
          "source": "govconnect.dlx",
          "vhost": "govconnect",
          "destination": "dlq.messages",
          "destination_type": "queue",
          "routing_key": "dlq.messages"
        },
        {
          "source": "govconnect.dlx",
          "vhost": "govconnect",
          "destination": "dlq.ai",
          "destination_type": "queue",
          "routing_key": "dlq.ai"
        }
      ]
    }

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: govconnect
  labels:
    app.kubernetes.io/name: rabbitmq
    app.kubernetes.io/component: messaging
spec:
  serviceName: rabbitmq
  replicas: 1
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
        app.kubernetes.io/name: rabbitmq
    spec:
      containers:
        - name: rabbitmq
          image: rabbitmq:3.13-management-alpine
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 5672
              name: amqp
            - containerPort: 15672
              name: management
          env:
            - name: RABBITMQ_DEFAULT_USER
              valueFrom:
                secretKeyRef:
                  name: govconnect-secrets
                  key: RABBITMQ_USER
            - name: RABBITMQ_DEFAULT_PASS
              valueFrom:
                secretKeyRef:
                  name: govconnect-secrets
                  key: RABBITMQ_PASSWORD
            - name: RABBITMQ_DEFAULT_VHOST
              value: "govconnect"
          volumeMounts:
            - name: rabbitmq-data
              mountPath: /var/lib/rabbitmq
            - name: rabbitmq-config
              mountPath: /etc/rabbitmq/rabbitmq.conf
              subPath: rabbitmq.conf
            - name: rabbitmq-config
              mountPath: /etc/rabbitmq/definitions.json
              subPath: definitions.json
          resources:
            requests:
              memory: "256Mi"
              cpu: "250m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            exec:
              command:
                - rabbitmq-diagnostics
                - ping
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            exec:
              command:
                - rabbitmq-diagnostics
                - ping
            initialDelaySeconds: 20
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: rabbitmq-data
          persistentVolumeClaim:
            claimName: rabbitmq-pvc
        - name: rabbitmq-config
          configMap:
            name: rabbitmq-config
