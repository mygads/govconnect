# ===================================================================================
# GOVCONNECT - ENVIRONMENT CONFIGURATION
# ===================================================================================
#
# USAGE:
#   cp .env.example .env
#   # Edit values according to your environment
#
# DOCKER COMPOSE FILES:
#   - docker-compose.yml        = Local development (builds from source)
#   - docker-compose.swarm.yml  = Production on server (uses GHCR images)
#
# ARCHITECTURE NOTE:
# ┌───────────────────────────────────────────────────────────────────────────────┐
# │  DIRECT SERVICE COMMUNICATION (NO AGGREGATED GATEWAY)                          │
# │                                                                               │
# │  Dashboard/AI/Channel/Case/Notification saling berkomunikasi langsung           │
# │  via URL service masing-masing (internal Docker network).                      │
# │                                                                               │
# │  INTERNAL ACCESS:                                                              │
# │  http://channel-service:3001                                                   │
# │  http://ai-service:3002                                                        │
# │  http://case-service:3003                                                      │
# │  http://notification-service:3004                                              │
# └───────────────────────────────────────────────────────────────────────────────┘
#
# VARIABLE AUDIT (2026-02-26):
#   Semua variabel di file ini sudah diverifikasi terpakai di source code.
#   Dead vars sudah dihapus: NEXTAUTH_SECRET, NEXTAUTH_URL, IMAGE_TAG,
#   GENFITY_APP_API_URL, GENFITY_APP_CUSTOMER_API_KEY, DASHBOARD_SERVICE_URL_INTERNAL
#
# ===================================================================================

# ==================== ENVIRONMENT ====================
NODE_ENV=production
LOG_LEVEL=info

# Port mapping (host) overrides
# Jika port 3000 bentrok dengan app lain di laptop, set ke 3010/3020/dll.
DASHBOARD_PORT=3000

# ==================== DATABASE (PostgreSQL) ====================
# Each service gets its own DATABASE_URL via docker-compose environment override
# Format: postgresql://USER:PASSWORD_URLENCODED@HOST:PORT/DATABASE
# Password special chars must be URL-encoded (e.g., @ = %40, # = %23)
# Local: uses infra-postgres (container name)
# GCP: uses 172.17.0.1:6432 (docker bridge to host where PgBouncer runs)
DATABASE_URL_CHANNEL=postgresql://postgres:your_password@infra-postgres:5432/gc_channel
DATABASE_URL_AI=postgresql://postgres:your_password@infra-postgres:5432/gc_ai
DATABASE_URL_CASE=postgresql://postgres:your_password@infra-postgres:5432/gc_case
DATABASE_URL_NOTIFICATION=postgresql://postgres:your_password@infra-postgres:5432/gc_notification
DATABASE_URL_DASHBOARD=postgresql://postgres:your_password@infra-postgres:5432/gc_dashboard

# ==================== RABBITMQ ====================
# RABBITMQ_USER & RABBITMQ_PASSWORD kept as fallback for rabbitmq.service.ts
RABBITMQ_USER=admin
RABBITMQ_PASSWORD=your_secure_rabbitmq_password
RABBITMQ_URL=amqp://admin:your_password@rabbitmq:5672/govconnect
# Management URL (dipakai oleh semua 4 backend services untuk health check)
RABBITMQ_MANAGEMENT_URL=http://rabbitmq:15672

# ==================== SERVICE URLs (internal Docker network) ====================
CHANNEL_SERVICE_URL=http://channel-service:3001
AI_SERVICE_URL=http://ai-service:3002
CASE_SERVICE_URL=http://case-service:3003
NOTIFICATION_SERVICE_URL=http://notification-service:3004
DASHBOARD_SERVICE_URL=http://dashboard:3000

# ==================== SECURITY ====================
# Generate secrets: openssl rand -base64 32
INTERNAL_API_KEY=your_secure_internal_api_key_here
JWT_SECRET=your_secure_jwt_secret_here

# Encryption key for PII data (AES-256-GCM) — used by AI Service
# Generate: openssl rand -hex 32
# Jika kosong, enkripsi PII dinonaktifkan (tidak direkomendasikan di production)
PROFILE_ENCRYPTION_KEY=

# IP allowlist untuk webhook WhatsApp (comma-separated)
# Hanya terima webhook dari IP yang terdaftar (defense-in-depth)
# Jika kosong, semua IP diterima (dev mode / behind trusted reverse proxy)
# Contoh: WEBHOOK_ALLOWED_IPS=104.21.32.1,172.67.180.1
WEBHOOK_ALLOWED_IPS=

# ==================== WHATSAPP API ====================
# Base URL WhatsApp gateway (harus mengarah ke prefix `/v1/wa`)
# Direkomendasikan: pakai genfity-wa-support sebagai gateway validasi token/subscription.
# Contoh:
# - Public: https://api-wa.genfity.com/v1/wa
WA_API_URL=https://api-wa.genfity.com/v1/wa
# Verify token untuk webhook (opsional). Jika kosong, Channel Service akan menerima verifikasi tanpa token.
WA_WEBHOOK_VERIFY_TOKEN=

# Session creation via genfity-wa-support internal API (used by channel-service)
# WA_SUPPORT_URL: base URL genfity-wa-support (tanpa trailing slash)
# WA_SUPPORT_INTERNAL_API_KEY: API key format "source:key" atau plain key
WA_SUPPORT_URL=https://api-wa.genfity.com
WA_SUPPORT_INTERNAL_API_KEY=your_wa_support_api_key

# Jika true, Channel Service tidak akan mengirim request keluar ke WhatsApp provider
# (berguna untuk simulasi tenant isolation)
# Untuk local dev tanpa WA provider, set true agar tombol Connect/QR tidak 500
WA_DRY_RUN=false

# ==================== TESTING MODE ====================
# Enable testing mode to skip WhatsApp API calls (true/false)
# When enabled: messages processed but not sent to WhatsApp
TESTING_MODE=false

# ==================== AI / LLM ====================
# Get key from: https://aistudio.google.com/apikey
# Used by: AI Service (full NLU), Case Service (micro LLM type resolver)
GEMINI_API_KEY=your_gemini_api_key_here
LLM_TEMPERATURE=0.3
LLM_MAX_TOKENS=3000
LLM_TIMEOUT_MS=30000
MAX_HISTORY_MESSAGES=30

# ==================== NLU PROCESSOR CONFIGURATION ====================
# MICRO_NLU_MODELS: Small/fast models for classification & matching (comma-separated)
#   Used by: AI Service (intent, confirmation, query expansion, type/service matching)
#            Case Service (server-side complaint type resolution)
# FULL_NLU_MODELS: Quality models for response generation (comma-separated)
MICRO_NLU_MODELS=gemini-2.0-flash-lite,gemini-2.5-flash-lite
FULL_NLU_MODELS=gemini-2.0-flash,gemini-2.5-flash

# ==================== SPAM GUARD ====================
# Proteksi spam: bubble chat, spam teks identik, rate spam
SPAM_GUARD_ENABLED=true
SPAM_GUARD_MAX_IDENTICAL=5
SPAM_GUARD_BAN_DURATION_MS=60000

# Rate spam: ban user jika >N pesan dalam M detik
SPAM_RATE_MAX_MESSAGES=10
SPAM_RATE_WINDOW_MS=10000

# ==================== RATE LIMITING ====================
RATE_LIMIT_ENABLED=true
MAX_REPORTS_PER_DAY=5
COOLDOWN_SECONDS=30
AUTO_BLACKLIST_VIOLATIONS=10

# ==================== URLS ====================
MEDIA_PUBLIC_URL=https://channel.govconnect.my.id/uploads
# Internal base URL untuk akses media via jaringan docker (dipakai antar-service)
MEDIA_INTERNAL_URL=http://channel-service:3001/uploads
# Path storage file di container Channel Service
MEDIA_STORAGE_PATH=/app/uploads

# Dashboard URL (untuk link alert urgent di Notification Service)
# Harus mengarah ke public URL dashboard (bukan internal docker URL)
DASHBOARD_URL=https://govconnect.my.id

# Public base URL untuk webhook/preview channel
PUBLIC_BASE_URL=https://govconnect.my.id
PUBLIC_CHANNEL_BASE_URL=https://channel.govconnect.my.id

# LOCAL TIP:
# Kalau jalanin via docker-compose local tanpa domain publik, kamu bisa set:
# PUBLIC_CHANNEL_BASE_URL=http://localhost:3001

# Public form base URL (AI & public form)
PUBLIC_FORM_BASE_URL=https://govconnect.my.id

# ==================== CASE SERVICE ====================
ID_PREFIX_COMPLAINT=LAP
ID_PREFIX_SERVICE_REQUEST=LAY

# ==================== LOGGING ====================
LOG_DIR=logs

# ==================== SEO & ANALYTICS ====================
# App URL untuk SEO (gunakan domain production)
NEXT_PUBLIC_APP_URL=https://govconnect.my.id

# Google Tag Manager
# Dapatkan dari: https://tagmanager.google.com
NEXT_PUBLIC_GTM_ID=GTM-MXDV48SG

# Google Analytics 4 (opsional)
# Dapatkan dari: https://analytics.google.com → Admin → Data Streams → Web
# NEXT_PUBLIC_GA_MEASUREMENT_ID=G-XXXXXXXXXX

# Google Search Console Verification
# Dapatkan dari: https://search.google.com/search-console
NEXT_PUBLIC_GOOGLE_VERIFICATION=RDCMbbVmAgibeAL-LxyEZkEZXHRhXCsGkWUnw7q5cdk

# Bing Webmaster Tools (opsional)
# NEXT_PUBLIC_BING_VERIFICATION=YOUR_BING_CODE

# ==================== KNOWLEDGE/RAG ====================
USE_RAG_SEARCH=true
