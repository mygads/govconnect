# ===================================================================================
# GOVCONNECT SERVICES - DOCKER COMPOSE (SWARM MODE)
# ===================================================================================
# 
# High-availability deployment with Docker Swarm
# Uses pre-built images from GitHub Container Registry (GHCR)
# All values MUST be set in .env file
#
# USAGE:
#   cp .env.example .env   # Edit with your values
#   docker stack deploy -c docker-compose.yml govconnect
#
# UPDATE:
#   docker service update --image ghcr.io/mygads/govconnect-channel-service:latest govconnect_channel-service
#
# SCALE:
#   docker service scale govconnect_channel-service=3
#
# ===================================================================================

services:
  # ===================================================================================
  # Service 1: Channel Service (WhatsApp Gateway)
  # ===================================================================================
  channel-service:
    image: ghcr.io/mygads/govconnect-channel-service:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 3001
      SERVICE_NAME: channel-service
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/gc_channel
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/govconnect
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      WA_WEBHOOK_VERIFY_TOKEN: ${WA_WEBHOOK_VERIFY_TOKEN}
      WA_API_URL: ${WA_API_URL}
      WA_ACCESS_TOKEN: ${WA_ACCESS_TOKEN}
      CASE_SERVICE_URL: http://case-service:3003
      NOTIFICATION_SERVICE_URL: http://notification-service:3004
      MEDIA_STORAGE_PATH: /app/uploads
      MEDIA_INTERNAL_URL: http://channel-service:3001/uploads
      MEDIA_PUBLIC_URL: ${MEDIA_PUBLIC_URL}
      MESSAGE_BATCH_DELAY_MS: ${MESSAGE_BATCH_DELAY_MS}
      MAX_BATCH_SIZE: ${MAX_BATCH_SIZE}
      LOG_LEVEL: ${LOG_LEVEL}
    volumes:
      - channel-uploads:/app/uploads
    networks:
      - govconnect-network
      - infra-network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        # Channel API - strip /channel prefix
        - "traefik.http.routers.channel.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/channel`)"
        - "traefik.http.routers.channel.entrypoints=websecure"
        - "traefik.http.routers.channel.tls.certresolver=letsencrypt"
        - "traefik.http.routers.channel.middlewares=channel-strip"
        - "traefik.http.middlewares.channel-strip.stripprefix.prefixes=/channel"
        - "traefik.http.services.channel.loadbalancer.server.port=3001"
        # Webhook - no strip (path expected by WhatsApp)
        - "traefik.http.routers.webhook.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/webhook`)"
        - "traefik.http.routers.webhook.entrypoints=websecure"
        - "traefik.http.routers.webhook.tls.certresolver=letsencrypt"
        - "traefik.http.routers.webhook.service=channel"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===================================================================================
  # Service 2: AI Orchestrator (with Vector Database)
  # ===================================================================================
  ai-service:
    image: ghcr.io/mygads/govconnect-ai-service:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 3002
      SERVICE_NAME: ai-service
      # AI Service has its own database for vector storage
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/gc_ai
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/govconnect
      CHANNEL_SERVICE_URL: http://channel-service:3001
      CASE_SERVICE_URL: http://case-service:3003
      DASHBOARD_SERVICE_URL: http://dashboard:3000
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      LLM_TEMPERATURE: ${LLM_TEMPERATURE}
      LLM_MAX_TOKENS: ${LLM_MAX_TOKENS}
      LLM_TIMEOUT_MS: ${LLM_TIMEOUT_MS}
      MAX_HISTORY_MESSAGES: ${MAX_HISTORY_MESSAGES}
      USE_2_LAYER_ARCHITECTURE: ${USE_2_LAYER_ARCHITECTURE}
      TESTING_MODE: ${TESTING_MODE}
      LOG_LEVEL: ${LOG_LEVEL}
    volumes:
      - ai-service-data:/app/data
    networks:
      - govconnect-network
      - infra-network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        # AI API - strip /ai prefix
        - "traefik.http.routers.ai.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/ai`)"
        - "traefik.http.routers.ai.entrypoints=websecure"
        - "traefik.http.routers.ai.tls.certresolver=letsencrypt"
        - "traefik.http.routers.ai.middlewares=ai-strip"
        - "traefik.http.middlewares.ai-strip.stripprefix.prefixes=/ai"
        - "traefik.http.services.ai.loadbalancer.server.port=3002"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===================================================================================
  # Service 3: Case Service (Laporan & Tiket)
  # ===================================================================================
  case-service:
    image: ghcr.io/mygads/govconnect-case-service:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 3003
      SERVICE_NAME: case-service
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/gc_case
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/govconnect
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL}
    networks:
      - govconnect-network
      - infra-network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        # Case API - strip /case prefix
        - "traefik.http.routers.case.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/case`)"
        - "traefik.http.routers.case.entrypoints=websecure"
        - "traefik.http.routers.case.tls.certresolver=letsencrypt"
        - "traefik.http.routers.case.middlewares=case-strip"
        - "traefik.http.middlewares.case-strip.stripprefix.prefixes=/case"
        - "traefik.http.services.case.loadbalancer.server.port=3003"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===================================================================================
  # Service 4: Notification Service
  # ===================================================================================
  notification-service:
    image: ghcr.io/mygads/govconnect-notification-service:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: ${NODE_ENV}
      PORT: 3004
      SERVICE_NAME: notification-service
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/gc_notification
      RABBITMQ_URL: amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/govconnect
      CHANNEL_SERVICE_URL: http://channel-service:3001
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      LOG_LEVEL: ${LOG_LEVEL}
    networks:
      - govconnect-network
      - infra-network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        # Notification API - strip /notification prefix
        - "traefik.http.routers.notification.rule=Host(`api.govconnect.my.id`) && PathPrefix(`/notification`)"
        - "traefik.http.routers.notification.entrypoints=websecure"
        - "traefik.http.routers.notification.tls.certresolver=letsencrypt"
        - "traefik.http.routers.notification.middlewares=notification-strip"
        - "traefik.http.middlewares.notification-strip.stripprefix.prefixes=/notification"
        - "traefik.http.services.notification.loadbalancer.server.port=3004"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===================================================================================
  # Service 5: Dashboard (Next.js)
  # ===================================================================================
  dashboard:
    image: ghcr.io/mygads/govconnect-dashboard:${IMAGE_TAG:-latest}
    environment:
      NODE_ENV: ${NODE_ENV}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/gc_dashboard
      JWT_SECRET: ${JWT_SECRET}
      # Single API endpoint via Traefik (internal Docker network)
      API_BASE_URL: http://traefik
      INTERNAL_API_KEY: ${INTERNAL_API_KEY}
      NEXT_PUBLIC_APP_NAME: "GovConnect Dashboard"
      NEXTAUTH_URL: ${NEXTAUTH_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
    networks:
      - govconnect-network
      - infra-network
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.dashboard.rule=Host(`govconnect.my.id`)"
        - "traefik.http.routers.dashboard.entrypoints=websecure"
        - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
        - "traefik.http.services.dashboard.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s

# ===================================================================================
# NETWORKS
# ===================================================================================
networks:
  govconnect-network:
    external: true
    name: govconnect-network
  infra-network:
    external: true
    name: infra-network

# ===================================================================================
# VOLUMES
# ===================================================================================
volumes:
  channel-uploads:
    driver: local
  ai-service-data:
    driver: local
